#!/usr/bin/env node
var sys = require('sys');

var bbServer = require('../lib/bb-server.js'),
    argv = require('optimist').argv;

if (argv.h || argv.help) {
    console.log([
        "usage: bb-server [root] [options]",
        "",
        "options:",
        "  -r --root          Root to serve the files from",
        "  -p --port          Port to use [HTTPSERVER_PORT || 8080]",
        "  -a --address       Address to use [HTTPSERVER_IPADDR || 0.0.0.0]",
        "  -b --block         Block directory contents",
        "  -i --index         Send index.htm[l] when present in directory",
        "  -f --forward       Forward url/prefix to target",
        "  --prefix           [db]",
        "  --target           [http://localhost:5984]",
        "  -h --https         Start https server",
        "  -s --sessions      Enable sessions (adds sessions to req)",
        "  -ws --websocket    Turn on websocket server",
        "  -c --cache         Enable cache (instead of Cache-Control:No-store)",
        "  -ns --nostrip      Don't try to strip 48 chars from filename (cache signing)",
        "  -g --gzip          Regular expression of types to gzip  (true =[/text/javascript/json/])",
        "  -e- --escaped      Serve static content when asked, assign bot to serve static content to all bots",
        "  -l --log           Write log to the pwd, or follow with desired path",
        "  -nm --nomarkdown   Don't convert .md or .markdown files to html",
        "  -s --silent        Suppress messages from output",
        "  --file             load options from .json file",
        "  -h --help          Print this list and exit."
    ].join('\n'));
  process.exit();
}

function readConfigFile(fileName) {
    var parsedJSON;
    try { parsedJSON = require('fs').readFileSync(fileName);
          // console.log('Config file read.', parsedJSON);
          parsedJSON = JSON.parse(parsedJSON);
        } catch (e) {
            console.log('Error reading config file: ', e);
        }
    return parsedJSON;
} 

if (argv.file) {
    argv = readConfigFile(argv.file);
    // console.log(argv);
}

bbServer.go(argv);
